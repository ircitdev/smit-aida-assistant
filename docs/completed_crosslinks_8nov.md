# ะะฐะฒะตััะตะฝะฝะฐั ัะฐะฑะพัะฐ: ะะตัะตะบัะตััะฝัะต ัััะปะบะธ FreeScout โ AmoCRM

**ะะฐัะฐ:** 08 ะฝะพัะฑัั 2025
**ะัะตะผั:** 00:00 - 01:10

---

## ะัะฟะพะปะฝะตะฝะฝัะต ะทะฐะดะฐัะธ

### 1. โ ะัะพะฑัะฐะถะตะฝะธะต ัะพััะตัะฐ ะฒ ะฟะพะดะฐัะพะบ ะฒ ัะฐัะธัะฐั

**ะงัะพ ัะดะตะปะฐะฝะพ:**
- ะะฑะฝะพะฒะปะตะฝะฐ ััะฝะบัะธั `get_tariffs_gas()` ะฒ `/var/www/aida-gpt/server.py`
- ะขะฐัะธัั ั `router_included: true` ัะตะฟะตัั ะฟะพะบะฐะทัะฒะฐัั ๐ ะะพััะตั ะฒ ะฟะพะดะฐัะพะบ!
- 5 ัะฐัะธัะพะฒ ะพัะพะฑัะฐะถะฐัั ะธะฝะดะธะบะฐัะพั ะฟะพะดะฐัะบะฐ (Smit, ะะตะท ะณัะฐะฝะธั, ะะพะผะฐัะฝะธะน, ะัั ะฒะบะปััะตะฝะพ, SmitBussines100)

**ะขะตัั:** โ ะฃัะฟะตัะฝะพ (test_tariffs_display.py)

---

### 2. โ ะะตัะตะบัะตััะฝัะต ัััะปะบะธ FreeScout โ AmoCRM

**ะงัะพ ัะดะตะปะฐะฝะพ:**

#### 2.1. ะกััะปะบะธ ะฒ ัะพะพะฑัะตะฝะธะธ FreeScout
ะ ัะตะบััะต ัะพะพะฑัะตะฝะธั ัะธะบะตัะฐ ัะตะฟะตัั ะดะพะฑะฐะฒะปััััั:
- ๐ AmoCRM ะะธะด: `https://pavelsmit34ru.amocrm.ru/leads/detail/{lead_id}`
- ๐ค AmoCRM ะะพะฝัะฐะบั: `https://pavelsmit34ru.amocrm.ru/contacts/detail/{contact_id}`

**ะะพะด:** `create_lead()` ััะฝะบัะธั, ัััะพะบะฐ ~950

#### 2.2. ะะฐะฟะพะปะฝะตะฝะธะต ะฟัะพัะธะปั customer ะฒ FreeScout
ะะพัะปะต ัะพะทะดะฐะฝะธั ัะธะบะตัะฐ ะพะฑะฝะพะฒะปัะตััั ะฟัะพัะธะปั customer ั ะฟะพะปะฝัะผะธ ะดะฐะฝะฝัะผะธ:
- **ะะตะฑ-ัะฐะนั** (`websites[0]`): ัััะปะบะฐ ะฝะฐ AmoCRM ะบะพะฝัะฐะบั
- **ะะพัะพะด** (`address.city`): ะณะพัะพะด ะบะปะธะตะฝัะฐ
- **ะะดัะตั** (`address.address`): ะฟะพะปะฝัะน ะฐะดัะตั ะฟะพะดะบะปััะตะฝะธั
- **ะกะพััะพัะฝะธะต** (`address.state`): ะฝะฐะทะฒะฐะฝะธะต ัะฐัะธัะฐ

**ะคัะฝะบัะธั:** `update_freescout_customer_full()` (ัััะพะบะธ ~870-920)

**ะัะธะผะตั ัะตะทัะปััะฐัะฐ:**
```
ะะตะฑ-ัะฐะนั: https://pavelsmit34ru.amocrm.ru/contacts/detail/75005717
ะะพัะพะด: ะะพะปะณะพะณัะฐะด
ะะดัะตั: ะะพะปะณะพะณัะฐะด, ัะป. ะะตะฝะธะฝะฐ, ะด. 25, ะบะฒ. 10
ะกะพััะพัะฝะธะต: ะะตะท ะณัะฐะฝะธั โ 100 ะะฑะธั/ั ะทะฐ 1099 ััะฑ/ะผะตั
```

#### 2.3. ะะพะปััะตะฝะธะต customer_id
ะะพะฑะฐะฒะปะตะฝ ะดะพะฟะพะปะฝะธัะตะปัะฝัะน ะทะฐะฟัะพั ะฒ `create_freescout_ticket()` ะดะปั ะฟะพะปััะตะฝะธั `customer_id`:
1. ะกะพะทะดะฐะตััั conversation
2. ะะตะปะฐะตััั GET ะทะฐะฟัะพั ะบ `/api/conversations/{id}` ะดะปั ะฟะพะปััะตะฝะธั customer.id
3. Customer ID ะธัะฟะพะปัะทัะตััั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฟัะพัะธะปั

**ะะพะด:** `create_freescout_ticket()` ััะฝะบัะธั, ัััะพะบะธ ~1180-1200

---

### 3. โ๏ธ ะะตัะตะบัะตััะฝัะต ัััะปะบะธ AmoCRM โ FreeScout (ััะตะฑัะตั ััะพัะฝะตะฝะธั)

**ะกัะฐััั:** ะัะตะผะตะฝะฝะพ ะพัะบะปััะตะฝะพ ะดะพ ะฒัััะฝะตะฝะธั ะฟัะฐะฒะธะปัะฝะพะณะพ field_id

**ะัะพะฑะปะตะผะฐ:**
- ะะพะปะต `2563557` (HelpDesk ID) ะฝะต ัััะตััะฒัะตั ะฒ ะบะพะฝัะฐะบัะฐั AmoCRM
- ะัะธะฑะบะฐ API: `NotSupportedChoice` ะดะปั `field_id: 2563557`

**ะงัะพ ะฝัะถะฝะพ ััะพัะฝะธัั:**
1. ะ ะบะฐะบะพะผ ัะฐะทะดะตะปะต AmoCRM ัะพะทะดะฐะฝะพ ะฟะพะปะต "HelpDesk ID"?
   - ะ ะบะพะฝัะฐะบัะฐั?
   - ะ ะปะธะดะฐั?
2. ะะฐะบะพะน ะฟัะฐะฒะธะปัะฝัะน `field_id` ะธะปะธ `field_code` ะดะปั ััะพะณะพ ะฟะพะปั?

**ะะพะดะณะพัะพะฒะปะตะฝะฝะฐั ััะฝะบัะธั:** `update_amocrm_contact_helpdesk()` (ัััะพะบะธ ~790-830)

**ะะพะด ะทะฐะบะพะผะผะตะฝัะธัะพะฒะฐะฝ ะฒ:** `create_lead()` ััะฝะบัะธั, ัััะพะบะธ ~1045-1050

---

## ะคะฐะนะปั ะธะทะผะตะฝะตะฝะธะน

### ะัะฝะพะฒะฝะพะน ัะฐะนะป
- `/var/www/aida-gpt/server.py` - ะพะฑะฝะพะฒะปะตะฝ ั ะฝะพะฒัะผะธ ััะฝะบัะธัะผะธ

### ะกะพะทะดะฐะฝะฝัะต ัะบัะธะฟัั
1. `update_tariffs_display.py` - ะพะฑะฝะพะฒะปะตะฝะธะต ะพัะพะฑัะฐะถะตะฝะธั ัะฐัะธัะพะฒ
2. `add_crosslinks.py` - ะดะพะฑะฐะฒะปะตะฝะธะต ะฟะตัะตะบัะตััะฝัั ัััะปะพะบ
3. `fix_crosslinks.py` - ะธัะฟัะฐะฒะปะตะฝะธะต ะฟะพะปััะตะฝะธั customer_id
4. `update_freescout_fields.py` - ะทะฐะฟะพะปะฝะตะฝะธะต ะฟะพะปะตะน FreeScout
5. `fix_indentation.py` - ะธัะฟัะฐะฒะปะตะฝะธะต ะพััััะฟะพะฒ
6. `add_error_logging.py` - ะดะพะฑะฐะฒะปะตะฝะธะต ะดะตัะฐะปัะฝะพะณะพ ะปะพะณะธัะพะฒะฐะฝะธั

### ะขะตััั
1. `test_tariffs_display.py` - ัะตัั ะพัะพะฑัะฐะถะตะฝะธั ัะฐัะธัะพะฒ โ
2. `test_crosslinks.py` - ัะตัั ะฟะตัะตะบัะตััะฝัั ัััะปะพะบ
3. `test_final_crosslinks.py` - ัะธะฝะฐะปัะฝัะน ัะตัั
4. `test_quick_crosslink.py` - ะฑัััััะน ัะตัั ั ะปะพะณะธัะพะฒะฐะฝะธะตะผ
5. `test_complete_integration.py` - ะฟะพะปะฝัะน ัะตัั ะธะฝัะตะณัะฐัะธะธ โ

---

## ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

### ะกัะตะผะฐ ะฟะพัะพะบะฐ ะดะฐะฝะฝัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         create_lead()                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   create_amocrm_lead()             โ
         โ   1. ะกะพะทะดะฐะตั ะบะพะฝัะฐะบั               โ
         โ   2. ะกะพะทะดะฐะตั ะปะธะด                   โ
         โ   3. ะะพะฑะฐะฒะปัะตั ะฟัะธะผะตัะฐะฝะธะต          โ
         โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ ะะพะทะฒัะฐัะฐะตั: contact_id, lead_id
                      โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   ะคะพัะผะธัะพะฒะฐะฝะธะต ัะพะพะฑัะตะฝะธั FreeScout โ
         โ   + ะกััะปะบะธ ะฝะฐ AmoCRM ะปะธะด ะธ ะบะพะฝัะฐะบั โ
         โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   create_freescout_ticket()        โ
         โ   1. ะกะพะทะดะฐะตั conversation          โ
         โ   2. ะะพะปััะฐะตั customer_id          โ
         โ   3. ะะพะทะฒัะฐัะฐะตั ticket_number      โ
         โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ ะะพะทะฒัะฐัะฐะตั: ticket_number, customer_id
                      โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   update_freescout_customer_full() โ
         โ   ะะฑะฝะพะฒะปัะตั ะฟัะพัะธะปั customer:      โ
         โ   - website = AmoCRM ะบะพะฝัะฐะบั       โ
         โ   - city = ะณะพัะพะด                   โ
         โ   - address = ะฐะดัะตั                โ
         โ   - state = ัะฐัะธั                  โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั

### ะขะตัั #63 (ะฟะพัะปะตะดะฝะธะน ััะฟะตัะฝัะน)

**ะัะพะดะฝัะต ะดะฐะฝะฝัะต:**
```
ะะผั: ะะฒะฐะฝ ะกะธะดะพัะพะฒ
ะขะตะปะตัะพะฝ: +79007778899
ะะดัะตั: ะะพะปะณะพะณัะฐะด, ัะป. ะะตะฝะธะฝะฐ, ะด. 25, ะบะฒ. 10
ะะพัะพะด: ะะพะปะณะพะณัะฐะด
ะขะฐัะธั: ะะตะท ะณัะฐะฝะธั โ 100 ะะฑะธั/ั ะทะฐ 1099 ััะฑ/ะผะตั
```

**ะะตะทัะปััะฐัั:**
- โ AmoCRM ะบะพะฝัะฐะบั ัะพะทะดะฐะฝ: ID 75005717
- โ AmoCRM ะปะธะด ัะพะทะดะฐะฝ: ID 45927715
- โ FreeScout ัะธะบะตั ัะพะทะดะฐะฝ: #63
- โ FreeScout customer ะพะฑะฝะพะฒะปะตะฝ: ID 29

**ะัะพะฒะตัะบะฐ ะฒ FreeScout:**
- Conversation: https://support.smit34.ru/conversation/63
  - โ ะ ัะพะพะฑัะตะฝะธะธ ะตััั ัััะปะบะธ ะฝะฐ AmoCRM ะปะธะด ะธ ะบะพะฝัะฐะบั

- Customer Profile: https://support.smit34.ru/customers/29/edit
  - โ ะะตะฑ-ัะฐะนั: ัััะปะบะฐ ะฝะฐ AmoCRM ะบะพะฝัะฐะบั
  - โ ะะพัะพะด: ะะพะปะณะพะณัะฐะด
  - โ ะะดัะตั: ะะพะปะณะพะณัะฐะด, ัะป. ะะตะฝะธะฝะฐ, ะด. 25, ะบะฒ. 10
  - โ ะกะพััะพัะฝะธะต: ะะตะท ะณัะฐะฝะธั โ 100 ะะฑะธั/ั ะทะฐ 1099 ััะฑ/ะผะตั

**ะัะพะฒะตัะบะฐ ะฒ AmoCRM:**
- Lead: https://pavelsmit34ru.amocrm.ru/leads/detail/45927715
  - โ ะกัะฐััั: "ะขะฐัะธั ะฒัะฑัะฐะฝ" (79103554)
  - โ ะะพะฝัะฐะบั ะฟัะธะฒัะทะฐะฝ

- Contact: https://pavelsmit34ru.amocrm.ru/contacts/detail/75005717
  - โ ะกะพะทะดะฐะฝ ั ะบะฐััะพะผะฝัะผะธ ะฟะพะปัะผะธ
  - โ๏ธ ะะพะปะต "HelpDesk ID" ะฝะต ะทะฐะฟะพะปะฝะตะฝะพ (ััะตะฑัะตั ััะพัะฝะตะฝะธั field_id)

---

## API Endpoints ะธ ัะพัะผะฐัั

### FreeScout API

#### ะกะพะทะดะฐะฝะธะต conversation
```http
POST https://support.smit34.ru/api/conversations
Headers:
  X-FreeScout-API-Key: {api_key}
  Content-Type: application/json

Body:
{
  "type": "email",
  "mailboxId": 5,
  "subject": "...",
  "customer": {
    "email": "...",
    "firstName": "...",
    "phone": "..."
  },
  "threads": [{
    "text": "...",
    "type": "message",
    "user": 1
  }],
  "customFields": [
    {"id": 11, "value": "..."},
    {"id": 12, "value": "..."},
    ...
  ]
}
```

#### ะะฑะฝะพะฒะปะตะฝะธะต customer
```http
PUT https://support.smit34.ru/api/customers/{id}
Headers:
  X-FreeScout-API-Key: {api_key}
  Content-Type: application/json

Body:
{
  "websites": [{"value": "https://..."}],
  "address": {
    "city": "ะะพะปะณะพะณัะฐะด",
    "address": "ัะป. ะะตะฝะธะฝะฐ, ะด. 25, ะบะฒ. 10",
    "state": "ะะตะท ะณัะฐะฝะธั โ 100 ะะฑะธั/ั"
  }
}
```

### AmoCRM API

#### ะกะพะทะดะฐะฝะธะต ะบะพะฝัะฐะบัะฐ
```http
POST https://pavelsmit34ru.amocrm.ru/api/v4/contacts
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json

Body:
[{
  "name": "...",
  "custom_fields_values": [
    {"field_id": 2444397, "values": [{"value": "ะฐะดัะตั"}]},
    {"field_code": "PHONE", "values": [{"value": "+7...", "enum_code": "WORK"}]},
    {"field_id": 2444405, "values": [{"value": "ัะฐัะธั"}]},
    {"field_id": 2444421, "values": [{"value": "AI ะััะธััะตะฝั"}]}
  ]
}]
```

#### ะกะพะทะดะฐะฝะธะต ะปะธะดะฐ
```http
POST https://pavelsmit34ru.amocrm.ru/api/v4/leads
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json

Body:
[{
  "name": "ะะพะดะบะปััะตะฝะธะต: {ะฐะดัะตั}",
  "price": 0,
  "pipeline_id": 9963182,
  "status_id": 79103554,
  "_embedded": {
    "contacts": [{"id": {contact_id}}]
  }
}]
```

---

## ะะพะผะฐะฝะดั ะดะปั ะฟัะพะฒะตัะบะธ

### ะัะพะฒะตัะบะฐ ัะธะบะตัะฐ FreeScout
```bash
curl -s 'https://support.smit34.ru/api/conversations/{id}?embed=threads' \
  -H 'X-FreeScout-API-Key: dd2f001033f31ab74caa0db5c6f75553'
```

### ะัะพะฒะตัะบะฐ customer FreeScout
```bash
curl -s 'https://support.smit34.ru/api/customers/{id}' \
  -H 'X-FreeScout-API-Key: dd2f001033f31ab74caa0db5c6f75553'
```

### ะขะตัั ัะพะทะดะฐะฝะธั ะทะฐัะฒะบะธ
```bash
ssh root@31.44.7.144 "cd /var/www/aida-gpt && python3 /tmp/test_complete_integration.py"
```

---

## ะกะปะตะดัััะธะต ัะฐะณะธ

### ะขัะตะฑัะตั ะดะตะนััะฒะธะน:

1. **ะฃัะพัะฝะธัั ะฟะพะปะต HelpDesk ID ะฒ AmoCRM**
   - ะัะพะฒะตัะธัั ะฝะฐัััะพะนะบะธ ะฟะพะปะตะน: https://pavelsmit34ru.amocrm.ru/settings/fields/
   - ะะฐะนัะธ ะฟะพะปะต "HelpDesk ID" ะธะปะธ ัะพะทะดะฐัั ะฝะพะฒะพะต
   - ะะพะปััะธัั ะฟัะฐะฒะธะปัะฝัะน `field_id` ะธะปะธ `field_code`
   - ะะฐัะบะพะผะผะตะฝัะธัะพะฒะฐัั ะบะพะด ะฒ `create_lead()` (ัััะพะบะธ ~1045-1050)
   - ะะฑะฝะพะฒะธัั `field_id: 2563557` ะฝะฐ ะฟัะฐะฒะธะปัะฝะพะต ะทะฝะฐัะตะฝะธะต

2. **ะะฝัะตะณัะฐัะธั ัะธััะตะผะฝะพะณะพ ะฟัะพะผะฟัะฐ** (ะธะท ะฟัะตะดัะดััะตะน ะทะฐะดะฐัะธ)
   - ะะฐะผะตะฝะธัั "ะกัะตะฝะฐัะธะน 2: ะะพะฒัะน ะบะปะธะตะฝั" ะฒ SYSTEM_PROMPT
   - ะะพะฑะฐะฒะธัั ะธะฝััััะบัะธะธ ะฟะพ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพะผั ะฟัะตะดะปะพะถะตะฝะธั ััะปัะณ
   - ะะพะบัะผะตะฝัะฐัะธั ะณะพัะพะฒะฐ: `/var/www/aida-gpt/docs/aida_system_prompt.md`

### ะะฟัะธะพะฝะฐะปัะฝะพ:

3. **ะะพะฑะฐะฒะธัั ัััะปะบั ะฝะฐ FreeScout ะฒ ะฟัะธะผะตัะฐะฝะธะต AmoCRM ะปะธะดะฐ**
   - ะะพัะปะต ัะพะทะดะฐะฝะธั ัะธะบะตัะฐ ะดะพะฑะฐะฒะธัั note ะบ ะปะธะดั
   - ะคะพัะผะฐั: "๐ FreeScout Ticket: https://support.smit34.ru/conversation/{id}"

4. **ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั**
   - ะัะพะฒะตัะบะฐ ัะพัะผะฐัะฐ ัะตะปะตัะพะฝะฐ
   - ะัะพะฒะตัะบะฐ ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน
   - ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ API

---

## ะขะตะบััะตะต ัะพััะพัะฝะธะต

### ะกะตัะฒะธัั
- โ aida-gpt.service - Running (port 8900)
- โ aida-cache-bot.service - Running (@Smit34AIAssistant_bot)

### ะะฝัะตะณัะฐัะธะธ
- โ FreeScout โ AmoCRM (ัััะปะบะธ ะฒ ัะพะพะฑัะตะฝะธะธ)
- โ FreeScout customer profile (website, city, address, state)
- โ๏ธ AmoCRM โ FreeScout (ััะตะฑัะตั ััะพัะฝะตะฝะธั field_id)

### ะะตััะธั
- ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต: 08.11.2025 01:10
- Commit message: "ะะพะฑะฐะฒะปะตะฝั ะฟะตัะตะบัะตััะฝัะต ัััะปะบะธ FreeScout โ AmoCRM ะธ ะทะฐะฟะพะปะฝะตะฝะธะต ะฟัะพัะธะปั customer"

---

## ะะพะฝัะฐะบัั ะดะปั ะฟัะพะฒะตัะบะธ

### FreeScout
- URL: https://support.smit34.ru
- API Key: dd2f001033f31ab74caa0db5c6f75553
- Mailbox: 5 "ะะพะดะบะปััะตะฝะธะต"

### AmoCRM
- URL: https://pavelsmit34ru.amocrm.ru
- Pipeline: 9963182 (B2C)
- Status: 79103554 "ะขะฐัะธั ะฒัะฑัะฐะฝ"

### Google Apps Script
- Endpoint: ?action=get_tariffs
- Endpoint: ?action=get_addons

---

**ะะพะฝะตั ะดะพะบัะผะตะฝัะฐ**
